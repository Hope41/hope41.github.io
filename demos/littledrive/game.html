<body>
    <canvas id = c></canvas>
    <script>
        document.body.style.margin = 0
        document.body.style.overflow = 'hidden'
        document.body.style.backgroundColor = '#272'
        let ctx = c.getContext('2d')
        window.addEventListener('keydown', down)
        window.addEventListener('keyup', up)
        c.width = innerWidth
        c.height = innerHeight
        let key = {
            up: false,
            left: false,
            right: false
        }

        let roadLength = 3000
        let roadWidth = 100
        let roadRes = 5 // the size of each segment
        let turnExaggerate = 1.5
        let turnFrequency = .01
        let shoulderLength = 20
        let shoulderWidth = 20
        let fontSize = 2
        let record = roadLength
        let recordTime = 0
        let objectSize = 100
        let objectMax = 2
        let carsMax = 20
        let carsWidth = 30
        let carsHeight = 60
        let carTimer = carsHeight + 40
        let peopleMax = 5
        let peopleSize = 20

        let cars = [
            {
                title: 'Slow Invalid',
                roadSpeed: 2,
                landSpeed: .5,
                rotateSpeed: 1,
                color: '#776',
                windowcolor: '#333'
            }, {
                title: 'Gray Twizzy',
                roadSpeed: 3,
                landSpeed: 2,
                rotateSpeed: 2,
                color: '#888',
                windowcolor: '#333'
            }, {
                title: 'Smooth VW',
                roadSpeed: 5,
                landSpeed: 3,
                rotateSpeed: 3,
                color: '#bff',
                windowcolor: '#333'
            }, {
                title: 'Big Audi',
                roadSpeed: 5.1,
                landSpeed: 3,
                rotateSpeed: 3.5,
                color: '#000',
                windowcolor: '#0ff5'
            }, {
                title: 'Slick Lamborghini',
                roadSpeed: 6,
                landSpeed: 3,
                rotateSpeed: 3,
                color: '#bb6',
                windowcolor: '#333'
            }, {
                title: 'Formula 1',
                roadSpeed: 7,
                landSpeed: 2,
                rotateSpeed: 3,
                color: '#933',
                windowcolor: '#000'
            }, {
                title: 'The Monster',
                roadSpeed: 6,
                landSpeed: 6,
                rotateSpeed: 2,
                color: '#595',
                windowcolor: '#333'
            }, {
                title: 'Fast Bugatti',
                roadSpeed: 8,
                landSpeed: 7,
                rotateSpeed: 4,
                color: '#559',
                windowcolor: '#333'
            }
        ]

        let car = {
            x: c.width / 2,
            y: c.height / 2,
            width: 30,
            height: 60,
            angle: 90,
            speed: 0
        }

        let background = []
        let road = []
        let objects = []
        let othercars = []
        let explosion = []
        let people = []
        let turn = 0
        let carV = 0
        let rumble = 0
        let SL = shoulderLength
        let CT = carTimer
        let onroad = false
        let mainRoad = {
            x: c.width + 20,
            y: c.height / 2,
            width: 150,
            height: c.height
        }

        function down() {
            if (event.key == 'ArrowLeft') 
                key.left = true
            if (event.key == 'ArrowRight') 
                key.right = true
            if (event.key == 'ArrowUp') 
                key.up = true
        }

        function up() {
            if (event.key == 'ArrowLeft') 
                key.left = false
            if (event.key == 'ArrowRight') 
                key.right = false
            if (event.key == 'ArrowUp') 
                key.up = false
        }

        function random(min, max) {
            return (Math.random() * (max - min)) + min
        }

        function centerCollide(a, b) {
            if (a.x - a.width / 2 < b.x + b.width / 2 && a.x + a.width / 2 > b.x - b.width / 2 && a.y - a.height / 2 < b.y + b.height / 2 && a.y + a.height / 2 > b.y - b.height / 2) {
                return true
            } else 
                return false
        }

        function makeFloor() {
            let x = 0
            let y = 0
            let width = c.width
            let height = c.height / 10

            for (i = c.height / height; i--;) {
                y += height * 2

                background.push({x, y, width, height})
            }
        }

        function makeTrack() {
            x = c.width / 2
            y = c.height / 2
            width = roadWidth
            height = roadRes + 1 // +1 removes gaps

            for (i = roadLength / roadRes; i--;) {
                // SHOULDER CALCULATION
                shoulder = false
                SL -= roadRes
                if (SL < 0) {
                    shoulder = true
                    if (SL < -shoulderLength) {
                        shoulder = false
                        SL = shoulderLength
                    }
                }

                // FINISH CALCULATION
                finish = false
                if (i == 0) {
                    finish = true
                }

                // GENERATE ROAD
                turn += turnFrequency * roadRes

                y -= roadRes
                x += Math.sin(turn) * (turnExaggerate * roadRes) // road sways from side to side
                width += Math.sin(turn * 4) * (turnExaggerate * roadRes)

                road.unshift({
                    x,
                    y,
                    width,
                    height,
                    shoulder,
                    finish
                })
            }
        }

        function makeObjects() {
            place = Math.floor(random(0, 4))

            if (place == 0) { // top
                x = random(0, c.width)
                y = -objectSize / 2
            }
            if (place == 1) { // bottom
                x = random(0, c.width)
                y = c.height + objectSize / 2
            }
            if (place == 2) { // left
                x = -objectSize / 2
                y = random(0, c.height)
            }
            if (place == 3) { // right
                x = c.width + objectSize / 2
                y = random(0, c.height)
            }

            width = objectSize
            height = objectSize

            if (x + width / 2 > mainRoad.x - mainRoad.width / 2 && x - width / 2 < mainRoad.x + mainRoad.width / 2) 
                return
            for (i of road) 
                if (centerCollide(i, {
                    x: x,
                    y: y,
                    width: width,
                    height: height
                })) 
                    return

        objects.push({x, y, width, height})
        }

        function makeCars() {
            way = Math.floor(random(0, 2))
            label = ''
            width = carsWidth
            height = carsHeight
            color = '#' + Math
                .random()
                .toString(16)
                .substr(2, 6)
            angle = 0
            speed = random(2, 10)

            if (way == 0) {
                label = 'up'
                x = mainRoad.x - mainRoad.width / 2 + width * 1.5
                y = c.height + height / 2
                angle = 180
            }
            if (way == 1) {
                label = 'down'
                x = mainRoad.x + mainRoad.width / 2 - width * 1.5
                y = -height / 2
                angle = 0
            }

            othercars.push({
                x,
                y,
                width,
                height,
                color,
                label,
                angle,
                speed
            })
        }

        function makePeople() {
            place = Math.floor(random(0, 4))
            width = peopleSize
            height = peopleSize
            angle = random(0, 360)
            rot = random(0, 100)
            die = false

            if (place == 0) { // top
                x = random(0, c.width)
                y = -height / 2 + 1
            }
            if (place == 1) { // bottom
                x = random(0, c.width)
                y = c.height + height / 2 - 1
            }
            if (place == 2) { // left
                x = -width / 2 + 1
                y = random(0, c.height)
            }
            if (place == 3) { // right
                x = c.width + width / 2 - 1
                y = random(0, c.height)
            }

            if (x + width / 2 > mainRoad.x - mainRoad.width / 2 && x - width / 2 < mainRoad.x + mainRoad.width / 2) 
                return
            for (i of road) 
                if (centerCollide(i, {
                    x: x,
                    y: y,
                    width: width,
                    height: height
                })) 
                    return

        people.push({
                x,
                y,
                width,
                height,
                angle,
                rot,
                die
            })
        }

        function explode(x, y, size, amount, xspeed, randomness, color) {
            for (i = amount; i--;) {

                speed = xspeed + random(-randomness, randomness)
                angle = random(0, 360)

                explosion.push({
                    x,
                    y,
                    size,
                    speed,
                    angle,
                    color
                })
            }
        }

        function moveCar(angle, speed) { // deg
            x = speed * Math.cos(angle * Math.PI / 180)
            y = speed * Math.sin(angle * Math.PI / 180)

            for (i of road) {
                i.x += x
                i.y += y
            }
            for (i of objects) {
                i.x += x
                i.y += y
            }
            for (i of background) {
                i.y += y
            }

            for (i of othercars) {
                i.x += x
                i.y += y
            }

            for (i of explosion) {
                i.x += x
                i.y += y
            }

            for (i of people) {
                i.x += x
                i.y += y
            }

            mainRoad.x += x
        }

        function loop() {
            c.width = c.width

            // CONTROLS
            if (key.left) 
                car.angle -= cars[carV].rotateSpeed
            if (key.right) 
                car.angle += cars[carV].rotateSpeed
            if (key.up) {
                if (!onroad) {
                    car.speed = cars[carV].landSpeed
                }

                if (onroad) {
                    car.speed = cars[carV].roadSpeed
                    onroad = false
                }
            } else 
                car.speed = 0

            moveCar(car.angle, car.speed)

            if (objects.length < objectMax) 
                makeObjects()

            recordTime++

            for (i of background) {
                if (i.y > c.height) 
                    i.y = -i.height
                if (i.y < -i.height) 
                    i.y = c.height

                ctx.fillStyle = '#262'
                ctx.fillRect(i.x, i.y, i.width, i.height)
            }

            // RESET CARS POSITION AFTER RACE
            dx = car.x - road[road.length - 1].x
            dy = car.y - road[road.length - 1].y
            angle = Math.atan2(dy, dx)
            dist = dx / Math.cos(angle)
            if (centerCollide(car, road[0])) {
                moveCar(angle * (180 / Math.PI), dist)

                // UPDATE RECORD & CHANGE CAR TYPE
                if (carV < cars.length - 1 && recordTime < record) {
                    carV++
                    record = recordTime
                }
                recordTime = 0

                // REMAKE BACKGROUND
                background = []
                makeFloor()
            }

            for (i of road) {
                if (centerCollide(car, i)) 
                    onroad = true

                    // DRAW ROAD
                ctx.fillStyle = '#333'
                ctx.fillRect(i.x - i.width / 2, i.y, i.width, i.height)

                if (i.shoulder) {
                    ctx.fillStyle = '#fff9'
                    ctx.fillRect(i.x - i.width / 2 - shoulderWidth, i.y, shoulderWidth, i.height)
                    ctx.fillRect(i.x + i.width / 2, i.y, shoulderWidth, i.height)
                } else {
                    ctx.fillStyle = '#f009'
                    ctx.fillRect(i.x - i.width / 2 - shoulderWidth, i.y, shoulderWidth, i.height)
                    ctx.fillRect(i.x + i.width / 2, i.y, shoulderWidth, i.height)
                }

                if (i.finish) {
                    ctx.fillStyle = '#fff'
                    ctx.fillRect(i.x - i.width / 2, i.y, i.width, i.height)
                }
            }

            // DRAW MAIN ROAD
            ctx.fillStyle = '#333'
            ctx.fillRect(mainRoad.x - mainRoad.width / 2, mainRoad.y - mainRoad.height / 2, mainRoad.width, mainRoad.height)
            ctx.fillStyle = '#fff9'
            ctx.fillRect(mainRoad.x - mainRoad.width / 2, mainRoad.y - mainRoad.height / 2, mainRoad.width / 10, mainRoad.height)
            ctx.fillRect(mainRoad.x + mainRoad.width / 2 - mainRoad.width / 10, mainRoad.y - mainRoad.height / 2, mainRoad.width / 10, mainRoad.height)

            if (centerCollide(car, mainRoad)) 
                onroad = true

            if (people.length < peopleMax) 
                makePeople()

            for (i of people) {
                dx = i.x - car.x
                dy = i.y - car.y
                angle = Math.atan2(dy, dx)
                dist = dx / Math.cos(angle)

                if (dist < c.height / 3) {
                    i.x += Math.cos(angle) * random(1, 5)
                    i.y += Math.sin(angle) * random(1, 5)
                }

                i.rot += 0.4
                if (!centerCollide(i, {
                    x: c.width / 2,
                    y: c.height / 2,
                    width: c.width,
                    height: c.height
                })) 
                    people.splice(people.indexOf(i), 1)
                if (i.die) {
                    i.x += Math.cos(angle) * random(10, 15)
                    i.y += Math.sin(angle) * random(10, 15)
                }

                // could add: die = 'people.splice(people.indexOf(i), 1); explode(i.x, i.y, 5,
                // 3, 10, 0, "#000")'

                if (centerCollide(i, car)) 
                    i.die = true

                for (n of objects) {
                    if (centerCollide(i, n)) {
                        i.die = true
                    }
                }

                for (k of othercars) {
                    if (centerCollide(i, k)) {
                        i.die = true
                    }
                }

                ctx.save()
                ctx.translate(i.x, i.y)
                ctx.rotate((i.angle + 90) * Math.PI / 180)
                i.angle += Math.sin(i.rot) * 10

                x = Math.cos(i.angle * Math.PI / 180) / 3
                y = Math.sin(i.angle * Math.PI / 180) / 3

                i.x += x
                i.y += y

                ctx.fillStyle = '#000'
                ctx.fillRect(-i.width / 2, -i.height / 2, i.width, i.height / 2)
                ctx.fillStyle = '#874'
                ctx.beginPath()
                ctx.arc(0, -i.height / 4, i.height / 3, 0, 7)
                ctx.fill()
                ctx.fillStyle = '#000'
                ctx.fillRect(-i.width / 10, -i.height / 2, i.width / 10, i.width / 10)
                ctx.fillRect(i.width / 10, -i.height / 2, i.width / 10, i.width / 10)
                ctx.restore()
            }

            // DRAW CAR
            ctx.save()
            mh = -car.height / 2
            mw = -car.width / 2

            ctx.translate(c.width / 2, c.height / 2)
            ctx.rotate((car.angle + 90) * Math.PI / 180)

            if (cars[carV].title == 'Formula 1') {
                // FORMULA 1
                ctx.fillStyle = cars[carV].color;
                ctx.fillRect(mw / 3, mh + car.height / 10, car.width / 3, car.height - car.height / 20);
                ctx.fillRect(mw, -mh - car.height / 10, car.width, car.height / 10);
                ctx.fillRect(mw, mh + car.height / 10, car.width, car.height / 10);
                ctx.fillRect(mw, mh / 3, car.height / 2, car.height / 3);
                ctx.fillStyle = '#111';
                ctx.fillRect(mw - car.width / 5, mh / 3 + car.height / 5, car.width / 5, car.height / 5);
                ctx.fillRect(mw + car.width, mh / 3 + car.height / 5, car.width / 5, car.height / 5);
                ctx.fillRect(mw + car.width, mh / 3 - car.height / 10, car.width / 5, car.height / 5);
                ctx.fillRect(mw - car.width / 5, mh / 3 - car.height / 10, car.width / 5, car.height / 5);
                cars[carV].windowcolor;
                ctx.fillRect(-car.height / 20, mh + car.height / 2, car.height / 10, car.height / 10)
            } else {
                // CAR
                ctx.fillStyle = cars[carV].color
                ctx.fillRect(mw, mh, car.width, car.height)
                ctx.fillStyle = cars[carV].windowcolor
                ctx.fillRect(mw, mh + car.height / 1.5, car.width, car.height / 10)
                ctx.fillRect(mw, mh + 10, car.width, car.height / 20)
            }
            ctx.restore()

            rumble--
            if (rumble > 0) 
                moveCar(random(0, 360), 10)

            CT -= (car.speed + 1) / 2
            if (othercars.length < carsMax && CT < 0) {
                makeCars()
                CT = carTimer
            }
            for (i of othercars) {
                if (i.y > c.height + i.height / 2 || i.y < -i.height / 2) 
                    othercars.splice(othercars.indexOf(i), 1)

                crash = 'othercars.splice(othercars.indexOf(i), 1); explode(i.x + i.width / 2, i.y + i.he' +
                        'ight / 2, 100, 100, 100, 100, "#0002")'

                for (n of objects) {
                    if (centerCollide(i, n)) {
                        eval(crash)
                    }
                }

                if (centerCollide(car, i)) {
                    ctx.fillStyle = '#000'
                    ctx.fillRect(0, 0, c.width, c.height)

                    eval(crash)
                    rumble = 20
                }

                for (k of othercars) {
                    if (centerCollide(i, k)) {
                        if (k.y < i.y) {
                            if (k.label == i.label) {
                                if (i.label == 'up') 
                                    i.x += 3
                                if (i.label == 'down') 
                                    i.x -= 3
                            } else {
                                if (i.label == 'up') 
                                    i.x -= 3
                                if (i.label == 'down') 
                                    i.x += 3
                            }
                        }
                    }
                }

                ctx.save()
                ctx.translate(i.x, i.y)
                ctx.rotate(i.angle * Math.PI / 180)

                mh = -car.height / 2
                mw = -car.width / 2

                ctx.fillStyle = i.color
                ctx.fillRect(mw, mh, i.width, i.height)
                ctx.fillStyle = '#333'
                if (i.label == 'up') {
                    i.y -= i.speed
                }
                if (i.label == 'down') {
                    i.y += i.speed
                }

                ctx.fillRect(mw, mh + i.height / 1.5, i.width, i.height / 10)
                ctx.fillRect(mw, mh + 10, i.width, i.height / 20)
                ctx.restore()
            }

            // OBJECTS
            for (i of objects) {
                if (i.x < -i.width || i.y < -i.height || i.x > c.width + i.width || i.y > c.height + i.height) 
                    objects.splice(objects.indexOf(i), 1)

                if (centerCollide(car, i)) {
                    speedx = car.speed * Math.cos(car.angle * Math.PI / 180)
                    speedy = car.speed * Math.sin(car.angle * Math.PI / 180)
                    i.x -= speedx
                    i.y -= speedy
                }

                ctx.fillStyle = '#653'
                ctx.fillRect(i.x - i.width / 2, i.y - i.height / 2, i.width, i.height)
                ctx.strokeRect(i.x - i.width / 2, i.y - i.height / 2, i.width, i.height)
            }

            for (i of explosion) {
                ctx.fillStyle = i.color
                ctx.fillRect(i.x - i.size / 2, i.y - i.size / 2, i.size, i.size)

                i.speed /= 1.1

                i.x += Math.cos(i.angle * Math.PI / 180) * i.speed
                i.y += Math.sin(i.angle * Math.PI / 180) * i.speed

                if (i.speed < 1) 
                    explosion.splice(i, 1)
            }

            ctx.font = fontSize + 'em arial'
            ctx.fillStyle = cars[carV].color
            ctx.fillText(cars[carV].title, 0, fontSize * 14)
            ctx.strokeText(cars[carV].title, 0, fontSize * 14)

            // DRAW RECORD & TIME
            ctx.fillStyle = '#0f0'
            if (recordTime > record) 
                ctx.fillStyle = '#f00'
            ctx.fillText('Time: ' + recordTime, 0, fontSize * 28)

            ctx.fillStyle = '#000'
            ctx.fillText('Fastest: ' + record, 0, fontSize * 42)

            ctx.font = '1em arial'
            ctx.fillText('Beat your record to earn new cars', 0, fontSize * 56)

            requestAnimationFrame(loop)
        }

        makeTrack()
        makeFloor()
        makeCars()
        loop()
    </script>
</body>