<!DOCTYPE html>
    <head>
        <style>
            body {
                background: #fff;
                margin: 0;
                overflow: hidden
            }
        </style>
    </head>
    <body>
        <script>
            'use strict'
            class Map {
                constructor(width, height) {
                    this.array = []
                    for (let i = 0; i < width * height; i ++) this.array.push(0)

                    this.width = width
                    this.height = height
                }

                generate() {
                    for (let i = 0; i < this.width * this.height; i ++) {
                        const I = i % this.width

                        if (i % (this.width * 2) < this.width && I % 2 == 0) {
                            this.array[i] = 1

                            if (i % (this.width * 4) < this.width && I % 4 == 0 ||
                                (i + this.width * 2) % (this.width * 4) < this.width &&
                                (I + 2) % 4 == 0) {
                                    const dir = random(0, 4)

                                    if (!dir) this.array[i-this.width] = 1
                                    if (dir == 1) this.array[i+1] = 1
                                    if (dir == 2) this.array[i+this.width] = 1
                                    if (dir == 3) this.array[i-1] = 1
                            }
                        }


                        if (I == 0 || I == this.width - 1 || 
                            i < this.width || i > this.height * this.width - this.width)
                                this.array[i] = 1
                    }
                }

                update() {
                    hero.update()
                }
            }

            class Player {
                constructor(x, y) {
                    this.x = x
                    this.y = y
                    this.width = .3
                    this.height = .3

                    this.angle = 0
                }

                update() {
                    this.angle ++
                    this.draw()
                }

                draw() {
                    for (let i = 0; i < ray_amount; i ++) {
                        // get the angle of each ray
                        const increment = fov / ray_amount
                        const angle = i * increment - fov / 2

                        // get the length of the ray
                        const length = getLength(
                            angle + hero.angle,
                            hero.x + hero.width / 2,
                            hero.y + hero.height / 2,
                            view_max
                        )

                        // get the height of the rectangle based on the rays length
                        const height = ((100 / length) * cvs.width) / 500

                        // get the colour of the rectangle based on the rays length
                        const shade = 50 / length

                        /* calculate the width of each rectangle (or segment)
                        based off the amount of rays and the width of the screen */
                        const segment_width = Math.floor(cvs.width / ray_amount) + 1

                        ctx.fillStyle = 'rgb(' +
                            shade + ',' +
                            shade + ',' +
                            shade / 2 + ',' +
                            (view_max - length) * 50 +
                        ')'
                        ctx.fillRect(
                            i * segment_width,
                            cvs.height / 2 + height / 2,
                            segment_width,
                            -height
                        )
                    }
                }
            }
            
            function getLength(angle, start_x, start_y, max_look = 0) {
                let length = 0

                for (let i = 0; i < max_look; i += ray_accuracy) {
                    length += ray_accuracy

                    const x = start_x + cos(angle) * length
                    const y = start_y + sin(angle) * length

                    const block = map.array[posToIndex(x, y, map.width)]

                    if (block) return i
                }

                return max_look
            }

            function collide(obj1, obj2) {
                return (
                    obj1.x < obj2.x + obj2.width &&
                    obj1.x + obj1.width > obj2.x &&
                    obj1.y < obj2.y + obj2.height &&
                    obj1.y + obj1.height > obj2.y
                )
            }

            function cos(angle) {
                return Math.cos(angle * Math.PI / 180)
            }

            function sin(angle) {
                return Math.sin(angle * Math.PI / 180)
            }

            function posToIndex(x, y, width) {
                return Math.floor(x) + Math.floor(y) * width
            }

            function random(min, max, int = 1) {
                const value = Math.random() * (max - min) + min

                return int ? Math.floor(value) : value
            }

            function resize() {
                cvs.width = innerWidth
                cvs.height = innerHeight
            }

            function update() {
                ctx.clearRect(0, 0, cvs.width, cvs.height)
                time ++

                map.update()

                requestAnimationFrame(update)
            }

            const cvs = document.createElement('canvas')
            const ctx = cvs.getContext('2d')
            const map = new Map(10, 10)
            const hero = new Player(5.4, 5.4)

            const view_max = 5
            const ray_accuracy = .02
            const ray_amount = Math.round(cvs.width)
            const fov = 100

            let time = 0

            document.body.appendChild(cvs)
            map.generate()

            addEventListener('resize', resize)
            resize()

            update()
        </script>
    </body>
</html>